intersections:
  # --- THE CLINIC BRIDGE (ID Identity) ---
  - source: "SAAS.CLINICS"
    target: "FINTECH.CLINICS"
    type: SAME_ENTITY
    join_logic: "Direct Join on `clinic_id`"
    description: >
      The Clinic ID is the master key of the ecosystem. 
      SaaS holds the Operational State (Is Active? Has Schedule?).
      Fintech holds the Risk State (Is Eligible? Fraud Score?).

  # --- THE PATIENT BRIDGE (CPF Resolution) ---
  - source: "SAAS.PATIENTS"
    target: "FINTECH.PATIENTS"
    type: SAME_NATURAL_PERSON
    join_logic: "Join on `CPF` (Tax ID)"
    warning: >
      Do NOT join on `patient_id`. The IDs are generated by different systems (SaaS vs Monolith).
      You must resolve `SaaS.patient_id` -> `CPF` -> `Fintech.patient_id`.

  # --- THE CONVERSION BRIDGE (Budget -> Simulation) ---
  - source: "SAAS.BUDGETS"
    target: "FINTECH.CREDIT_SIMULATIONS"
    type: FINANCES
    join_logic: |
      Heuristic Join:
      ON saas_budget.clinic_id = fintech_sim.retail_id
      AND saas_budget.patient_cpf = fintech_sim.patient_effective_cpf
      AND ABS(TIMESTAMP_DIFF(saas_budget.created_at, fintech_sim.created_at, 'HOUR')) <= 24
    description: >
      A Budget in the SaaS (Treatment Plan) generates a Checkout Intent, which creates a Credit Simulation.
      There is no direct FK yet. Use the heuristic window.

  # --- THE LEAD BRIDGE (Lead -> Schedule) ---
  - source: "FINTECH.CREDIT_LEADS"
    target: "SAAS.SCHEDULES"
    type: GENERATES_APPOINTMENT
    join_logic: "Via `external_integration_id` or Heuristic (Phone + Clinic + Time)"
    description: >
      A BNPL Lead (approved credit) often results in a scheduled appointment in the SaaS.
