# AXIOMS.yaml
# Logical constraints that MUST hold within the Capim Ecosystem
# Reference: MEMORY_ARCHITECTURE_CONSTITUTION §DIRECTIVE:ONTOLOGY_FORMALIZATION
# Last Updated: 2026-01-31

axioms:

  # === FINTECH DOMAIN ===

  - id: AX-FINTECH-001
    domain: FINTECH
    natural_language: "A simulation can only be approved if the clinic is BNPL eligible."
    formal: "APPROVED(sim) => BNPL_ELIGIBLE(sim.clinic_id)"
    severity: SOFT
    validation_query: |
      SELECT COUNT(*) AS violations
      FROM CAPIM_DATA_DEV.POSSANI_SANDBOX.C1_ENRICHED_BORROWER eb
      JOIN CAPIM_DATA_DEV.POSSANI_SANDBOX.CLINIC_DIM_V1 cd
        ON eb.clinic_id = cd.clinic_id
      WHERE eb.c1_outcome_bucket = 'approved'
        AND cd.clinic_is_bnpl_eligible = FALSE
      -- Expected: 0
    status: HOMOLOGATED
    last_validated: null
    notes: |
      ⚠️ Interpretação:
      - Em prática, "eligibility" pode ser um snapshot e não refletir o estado "as-of" do C1.
      - Mantido como SOFT até termos uma validação temporal/as-of para a elegibilidade.

  - id: AX-FINTECH-002
    domain: FINTECH
    natural_language: "A Request (C2) must have a matched C1 origin OR be synthetic (request_direct) OR be explicitly flagged as ID collision."
    formal: "REQUEST(r) => (C1_ORIGIN_MATCHED(r) OR C1_IS_SYNTHETIC(r) OR IS_C1_ID_COLLISION(r))"
    severity: SOFT
    validation_query: |
      -- In C2_ENRICHED_REQUESTS, `c1_is_synthetic` is TRUE when c1_origin_id is NULL (request_direct).
      -- Therefore: any non-synthetic request must have a matched C1 origin OR be explicitly flagged as ID collision.
      SELECT COUNT(*) AS violations
      FROM CAPIM_DATA_DEV.POSSANI_SANDBOX.C2_ENRICHED_REQUESTS
      WHERE c1_is_synthetic = FALSE
        AND c1_origin_matched = FALSE
        AND is_c1_id_collision = FALSE
      -- Expected: 0
    status: HOMOLOGATED
    last_validated: null
    notes: |
      ⚠️ Atualmente este axiom é SOFT porque:
      - A cobertura de `c1_origin_matched` para `pre_analysis` (legado) pode ser incompleta (muitos direct_pre_analysis_id não encontram C1 unificado).
      - Use este contador como monitoramento de drift/qualidade da bridge; promover para HARD após corrigir linkage/coverage.

  - id: AX-FINTECH-003
    domain: FINTECH
    natural_language: "Bureau checks must be associated with C1 events via the Bridge logic, not direct FK."
    formal: "JOIN(C1, BUREAU) => VIA_BRIDGE(C1, BUREAU)"
    severity: SOFT
    validation_query: null  # Enforced by code review, not data
    status: HOMOLOGATED
    last_validated: null

  - id: AX-FINTECH-004
    domain: FINTECH
    natural_language: "SCR check association uses a +/- 15 day time window."
    formal: "SCR_MATCH(c1, scr) => ABS(c1.created_at - scr.checked_at) <= 15 days"
    severity: SOFT
    validation_query: null  # Design constraint; enforced by bridge implementation/code review
    status: HOMOLOGATED
    last_validated: null

  - id: AX-FINTECH-005
    domain: FINTECH
    natural_language: "Risk score special codes (-1, 9) must not be averaged directly."
    formal: "AVG(risk_score) => EXCLUDE(risk_score IN [-1, 9])"
    severity: SOFT
    validation_query: null  # Enforced by using risk_capim_0_5 column
    status: HOMOLOGATED
    last_validated: null

  - id: AX-FINTECH-006
    domain: FINTECH
    natural_language: "A C1 can only convert to C2 if it was APPROVED. Not all approved C1s convert."
    formal: "HAS_C2(c1) => WAS_APPROVED(c1)"
    formal_extended: |
      # Regra de conversão C1→C2
      1. HAS_C2(c1) => WAS_APPROVED(c1)              # Necessário mas não suficiente
      2. WAS_APPROVED(c1) =/=> HAS_C2(c1)            # Nem todo aprovado converte
      3. WAS_APPROVED(c2) pode ser FALSE mesmo com c1_was_approved=TRUE  # C2 tem avaliação própria
    severity: SOFT
    validation_query: |
      -- Valida: nenhum C1 reprovado deve ter C2 associado
      SELECT COUNT(*) AS violations
      FROM CAPIM_DATA_DEV.POSSANI_SANDBOX.C1_LIFECYCLE
      WHERE c1_entity_type IN ('credit_simulation', 'pre_analysis')
        AND c1_was_approved = FALSE
        AND c2_n_requests > 0
      -- Expected: 0 (ou muito próximo, casos edge)
    status: HOMOLOGATED
    last_validated: null
    notes: |
      Contexto de negócio:
      - C1 (Credit Simulation / Pre-Analysis) precisa ser aprovado para gerar proposta
      - Aprovação em C1 != aprovação em C2 (C2 tem validações adicionais)
      - Taxa de conversão típica: ~12-15% dos C1 aprovados viram C2
      - Agente deve entender que "c2_count = 0" para C1 aprovado é ESPERADO, não erro

  # === SAAS DOMAIN ===

  - id: AX-SAAS-001
    domain: SAAS
    natural_language: "A clinic is considered churned if no SaaS activity in the last 90 days."
    formal: "CHURNED(clinic) <=> (NOW() - clinic.last_dash_activity_at) > 90 days"
    severity: SOFT
    validation_query: null  # Not a strict integrity constraint; this is a business diagnostic/classification.
    status: HOMOLOGATED
    last_validated: null
    notes: |
      Esta regra é uma definição/diagnóstico operacional (não uma invariância "Expected 0").
      Se necessário, mover para um "diagnostics catalog" em vez de AXIOMS.

  - id: AX-SAAS-002
    domain: SAAS
    natural_language: "has_signed_contract is a BNPL flag, NOT a SaaS subscription indicator."
    formal: "has_signed_contract(clinic) =/=> is_subscriber(clinic)"
    severity: HARD
    validation_query: null  # Semantic constraint; enforced by documentation
    status: HOMOLOGATED
    last_validated: null

  # === CROSS-DOMAIN ===

  - id: AX-CROSS-001
    domain: CROSS
    natural_language: "Clinic ID is the canonical join key between SAAS and FINTECH domains."
    formal: "JOIN(SAAS.entity, FINTECH.entity) => ON clinic_id"
    severity: HARD
    validation_query: null  # Structural constraint
    status: HOMOLOGATED
    last_validated: null

  - id: AX-CROSS-002
    domain: CROSS
    natural_language: "Patient ID does NOT match between SAAS and FINTECH; use CPF for cross-domain joins."
    formal: "JOIN(SAAS.PATIENT, FINTECH.PATIENT) => ON cpf, NOT ON patient_id"
    severity: HARD
    validation_query: null  # Structural constraint
    status: HOMOLOGATED
    last_validated: null

  - id: AX-CROSS-003
    domain: CROSS
    natural_language: "Budget to Simulation association requires heuristic matching (clinic + CPF + time window)."
    formal: "JOIN(BUDGET, SIMULATION) => HEURISTIC(clinic_id + cpf + time_window_24h)"
    severity: SOFT
    validation_query: null  # Design constraint
    status: DRAFT
    last_validated: null

  - id: AX-CROSS-004
    domain: CROSS
    natural_language: "ECOSYSTEM.CLINICS must have non-null clinic_id in canonical sources (analytics + sandbox mirror)."
    formal: "∀ clinic ∈ ECOSYSTEM.CLINICS: clinic.clinic_id IS NOT NULL"
    severity: HARD
    validation_query: |
      -- Validates the canonical minimum contract join key for clinics.
      -- Expected: 0
      WITH violations AS (
        SELECT 'CAPIM_DATA.CAPIM_ANALYTICS.CLINICS' AS source_name, COUNT(*) AS v
        FROM CAPIM_DATA.CAPIM_ANALYTICS.CLINICS
        WHERE clinic_id IS NULL
        UNION ALL
        SELECT 'CAPIM_DATA_DEV.POSSANI_SANDBOX.CLINIC_DIM_V1' AS source_name, COUNT(*) AS v
        FROM CAPIM_DATA_DEV.POSSANI_SANDBOX.CLINIC_DIM_V1
        WHERE clinic_id IS NULL
      )
      SELECT SUM(v) AS violations
      FROM violations;
    status: DRAFT
    last_validated: null
    notes: |
      Governança (Opção B estrita):
      - ECOSYSTEM.CLINICS é SAAS-owned (contrato canônico mínimo)
      - A validação roda em duas tabelas para reduzir risco de drift entre analytics e mirror sandbox

  - id: AX-CROSS-005
    domain: CROSS
    natural_language: "ECOSYSTEM.CLINICS must have unique clinic_id (no duplicates) in canonical sources (analytics + sandbox mirror)."
    formal: "∀ clinic_id: COUNT(clinic_id) = 1"
    severity: HARD
    validation_query: |
      -- Validates grain/PK integrity for clinic_id.
      -- Expected: 0
      WITH dup_analytics AS (
        SELECT clinic_id
        FROM CAPIM_DATA.CAPIM_ANALYTICS.CLINICS
        GROUP BY 1
        HAVING COUNT(*) > 1
      ),
      dup_sandbox AS (
        SELECT clinic_id
        FROM CAPIM_DATA_DEV.POSSANI_SANDBOX.CLINIC_DIM_V1
        GROUP BY 1
        HAVING COUNT(*) > 1
      )
      SELECT
        (SELECT COUNT(*) FROM dup_analytics)
        + (SELECT COUNT(*) FROM dup_sandbox) AS violations;
    status: DRAFT
    last_validated: null
