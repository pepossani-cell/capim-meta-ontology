# Session Notes: 2026-02-05

## Focus
CAPIM POS + PayFac Ecosystem Investigation and Crivo Architecture Finalization

## Accomplishments

### 1. CAPIM POS Deep Dive (SAAS Domain)
- ✅ **Profiled CAPIM_POS table**: 60 columns, ~2.2K clinics, comprehensive POS + PayFac + TAG metrics
- ✅ **Created visualization suite**: 6 charts covering TPV, cohorts, activation funnel, and equipment vs activity
- ✅ **Identified key metrics**:
  - 76.859 transactions processed (R$ 57M total TPV)
  - 1.704 unique clinics active in PayFac
  - Product launched May/2025, explosive growth (+97.600% clinics in 9 months)

### 2. Key Findings from Analysis
- **8% leakage** in activation funnel (Delivered → Activated)
  - 133 clinics receive POS but don't complete 2nd transaction
  - Opportunity: Improve onboarding post-delivery
- **Strong cohort performance**: Top 5 cohorts (Sep-Dec 2025) represent 82% of activated base
- **Healthy retention**: 70% of clinics that ordered POS are currently active
- **Growth momentum**: Jan/2026 cohort with 245 activations shows continued traction

### 3. Technical Implementation
- ✅ **Created consolidated script**: `ontologia-saas/scripts/studies/analyze_capim_pos_payfac.py`
  - Single-file approach (no project bloat)
  - Follows VISUALIZATION_STANDARDS.md (whitegrid + talk + pastel, DPI 220)
  - Handles Decimal → float conversion for matplotlib compatibility
- ✅ **Created findings script**: `analyze_pos_findings.py` for quick metrics extraction
- ✅ **Generated 6 visualizations** in `ontologia-saas/outputs/`:
  1. `viz1_tpv_rolling_30d.png` — TPV rolling 30d vs monthly total
  2. `viz2_n_clinics_active_monthly.png` — Active clinics month-over-month
  3. `viz3_cohort_tpv.png` — TPV by activation cohort (top 6)
  4. `viz4_cohort_pct_active.png` — % active by cohort over time
  5. `viz5_6_pos_equipment_vs_active.png` — POS orders vs active clinics + activation rate

### 4. Crivo Ecosystem (FINTECH Domain)
- ✅ **Archived 2 decisions** (18.1, 18.2) to `DECISIONS_ARCHIVE/2026-02-05_crivo_ecosystem.md`
- ✅ **Validated hash_cpf formula**: SHA256(digits_only_cpf) with 97.3% match rate
- ✅ **Clarified 3 distinct Crivo entities** with different purposes and coverage

### 5. Documentation Standards (All Projects)
- ✅ **Standardized Dual Doc Pattern** across all 3 ontology projects
- ✅ **Migrated data dictionaries**:
  - `bnpl-funil`: 14 files moved from `_domain/_docs/reference/` to `docs/reference/`
  - `client-voice-data`: 5 files moved, created `_domain/_docs/decisions/` folder
  - `ontologia-saas`: 2 files moved (CAPIM_POS.md, POS_ORDERS.md)
- ✅ **Updated Cursor Rule**: `.cursor/rules/entity_documentation.mdc` with new paths and validation script
- ✅ **Updated Skill**: `@investigate-entity` now generates files in correct locations
- ✅ **Added to LESSONS_LEARNED**: Dual Location Pattern documented

## Decisions Made
- **18.1**: Three Crivo Entities Confirmed (EXECUTED → Archived)
- **18.2**: hash_cpf formula confirmed (EXECUTED → Archived)
- **14.6**: Dual Doc Organization Pattern (EXECUTED → Archived)

## Decisions Archived
- 2 items moved to `DECISIONS_ARCHIVE/2026-02-05_crivo_ecosystem.md` (18.1, 18.2)
- 1 item moved to `DECISIONS_ARCHIVE/2026-02-05_documentation_standards.md` (14.6)

## Pending Items
- ~27 items remain in DECISIONS_IN_PROGRESS.md
- Key pending:
  - 17.1-17.7: Clinic Business Rules (Decided, need axiom formalization)
  - 18.3: Crivo Coverage Drop from Sep/2025 (Pending investigation)
  - 18.4: PRE_ANALYSES Zero Coverage in ANALYTICS (Decided)
  - 14.x: BNPL-Funil Phase B completion

## Knowledge Harvested

### Pattern: Product in Traction Phase
- **Explosive early growth** (+97.600% in 9 months) indicates product-market fit
- **Onboarding friction** (8% leakage) is typical for hardware products (POS)
- **Cohort concentration** in recent months (Sep-Dec 2025) requires close retention monitoring

### Pattern: Data Layer Awareness Critical
- PAYFAC_TRANSACTIONS lacks `revenue` and `is_spot` columns (simplified vs expected schema)
- Required on-the-fly adaptation of visualization scope (removed revenue/take-rate charts)
- Reinforces importance of **Zero Assumptions** protocol: always profile schema first

### Pattern: Decimal Type Handling in Python
- Snowflake returns `Decimal` types that break matplotlib arithmetic
- Solution: Convert to `float` immediately after query (`df[col].astype(float)`)
- Added to plot_utils.py best practices

### Anti-Pattern: CSV-based Analysis (Avoided)
- Original TODOs mentioned CSV + normalization (centavos → R$)
- Correctly pivoted to **Snowflake-first** approach (query aggregates directly)
- Reinforces: "Validate hypotheses WHERE THE DATA LIVES"

## Metrics
- **Queries executed**: 7 (PayFac transactions, cohorts, POS equipment, activation funnel, top cohorts, findings)
- **Visualizations generated**: 6 PNG files (DPI 220, ~120-220KB each)
- **Scripts created**: 2 (main analysis + findings extraction)
- **Lines of code**: ~450 (consolidated, no bloat)

## Next Steps

### Immediate (Next Session)
1. **Formalize Clinic Business Rules** (17.1-17.7):
   - Add AX-FINTECH-007 through AX-FINTECH-010 to `AXIOMS.yaml`
   - Update `CLINIC_DIM_V1_SEMANTIC.md` with reactivation and taxonomy findings

2. **Investigate Crivo Coverage Drop** (18.3):
   - Coordinate with Data Engineering to understand Sep/2025+ pipeline changes
   - Document root cause in `LESSONS_LEARNED.md`

3. **POS Onboarding Analysis**:
   - Deep dive into 133 clinics with delivery but no activation
   - Segment by: clinic type, delivery date, accreditation status
   - Identify blockers (technical issues, training gaps, feature requests)

### Medium-Term
4. **BNPL-Funil Phase B**: Complete remaining SANDBOX entities documentation
5. **Cross-domain POS Analysis**: Correlate POS activity with BNPL eligibility and SaaS subscription status
6. **Retention Curves**: Build proper survival analysis for POS cohorts (replace heuristic 30-day window)

## Files Modified
- `ontologia-saas/scripts/studies/analyze_capim_pos_payfac.py` (NEW)
- `ontologia-saas/scripts/studies/analyze_pos_findings.py` (NEW)
- `ontologia-saas/outputs/viz*.png` (6 files, NEW)
- `capim-meta-ontology/_memory/DECISIONS_ARCHIVE/2026-02-05_crivo_ecosystem.md` (NEW)
- `capim-meta-ontology/_memory/DECISIONS_ARCHIVE/2026-02-05_documentation_standards.md` (NEW)
- `capim-meta-ontology/_memory/DECISIONS_IN_PROGRESS.md` (UPDATED: archived 18.1, 18.2, 14.6)
- `capim-meta-ontology/_memory/LESSONS_LEARNED.md` (UPDATED: Dual Location Pattern)
- `capim-meta-ontology/.cursor/rules/entity_documentation.mdc` (UPDATED: new paths)
- `capim-meta-ontology/.cursor/skills/investigate-entity/SKILL.md` (UPDATED: correct output locations)
- `bnpl-funil/docs/reference/*.md` (14 files MOVED from _domain)
- `client-voice-data/docs/reference/*.md` (5 files MOVED from _domain)
- `client-voice-data/_domain/_docs/decisions/` (NEW folder with README + template)
- `ontologia-saas/docs/reference/CAPIM_POS.md` (MOVED from _domain)
- `ontologia-saas/docs/reference/POS_ORDERS.md` (MOVED from _domain)

## Session Duration
~3 hours (Crivo finalization + POS investigation + visualization suite)

---

**Note**: This session demonstrated effective **product-led investigation** — moving from raw data profiling to actionable business insights (8% leakage = 133 clinics = R$ 200-400K/month opportunity).
